
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>AJAX_API.textile</title>
<meta name="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen" charset="utf-8">
  <link rel="stylesheet" href="./css/screen.css" type="text/css" media="screen" charset="utf-8">
  <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" charset="utf-8">

</head>
<body>
<a href="/index.php" class="float-left" style="background:transparent;margin-right:.5em;"
    title="YASiteKit Home">
  <img src="/img/YASiteKitLogo.png" alt="YASiteKit.org Home" class="img-link" >
</a>
<a href="/doc.d/index.php" class="float-left" title="YASiteKit Doc">
  <img src="/img/ReadDoc.png" alt="Doc Index" class="img-link">
</a>

<h1>Ajax &#8211; Ajax <span class="caps">API</span> Design</h1>

<p>The <span class="caps">API</span> and functionality are encapsulated in the class <strong>AjaxRequest</strong>.</p>

<p>For any request, one and only one AjaxRequest instance will exist and
will be available globally in Globals::$web_service.</p>

<p>The actualization of the <span class="caps">AJAX</span> request is executed by the <strong>render_ajax.php</strong>
script &#8211; which:</p>

<ul>
<li>defines and instantiates the AjaxRequest class and object</li>
<li>locates and executes the requested ajax request script</li>
<li>implements, executes, and responds to the <span class="caps">AJAX</span> request script <span class="caps">API</span></li>
<li>produces all output which is sent to the client</li>
</ul>

<p>Here are the relevant parts of this document.</p>

<ul>
<li><a href="#render_ajax">render_ajax.php &#8211; top level <span class="caps">AJAX</span> processer</a></li>
<li><a href="#http_codes"><span class="caps">HTTP</span> Response Codes</a></li>
<li><a href="#ajax_request">AjaxRequest Class</a></li>
<li><a href="#script_api">ajax request script <span class="caps">API</span></a></li>
</ul>

<h2 id="render_ajax">render_ajax.php</h2>

<p><strong>render_ajax.php</strong> expects two parameters provided by a <span class="caps">POST</span> request:</p>

<ul>
<li>data_format &#8211; which specifies the format the request data will be returned
in. This will be one of <em>json, jsonp, xml, script, html,</em> or <em>text</em>.</li>
<li>ajax_request &#8211; which <span class="caps">MUST</span> be the name of an includeable file in
<em>private_data_root / ajax_scripts</em></li>
</ul>

<p>If either parameter is missing, the script immediately responds with
a <strong>400</strong> <span class="caps">HTTP</span> error &#8211; Bad Request and supplies an explanatory message.</p>

<p>If the required script is not in the <em>ajax_scripts</em> directory, then
it responds with a <strong>404</strong> &#8211; Not Found &#8211; error, again with an explanatory
message.</p>

<p>Then it declares and instantiates an <a href="#ajax_request">AjaxRequest</a> object
and executes the ajax_request script by reading the script into a string
and then using the <span class="caps">PHP</span> language construct _eval(). The script is not
evalauted using <em>include</em> or <em>require</em> in order to enforce the script location
requirements [this is a feature].</p>

<p>The <em>ajax_request</em> will define two functions as described <a href="#script_api">below</a>.</p>

<p>If the <em>ajax_request</em> fails to define the required functions, then <strong>render_ajax.php</strong>
returns <strong>500</strong> Internal Server Error with explanatory note. It also emails
the site technical content as given in Globals::$webmaster.</p>

<p>It then proceeds to check for required authority and execute <em>ajax_request</em>,
returning <span class="caps">HTTP</span> result codes as given in the <a href="#http_codes"><span class="caps">HTTP</span> Return Codes table</a></p>

<h2 id="http_codes"><span class="caps">HTTP</span> Return Codes</h2>

<table>
<tr>
<td>Code</td>
<td><span class="caps">HTTP</span> Meaning</td>
<td><span class="caps">AJAX</span> request success/failure</td>
<td>Content</td>
<td>Generated By</td>
<td>Notes</td>
</tr>
<tr>
<td>200</td>
<td>OK</td>
<td>success</td>
<td>content returned</td>
<td>ajax_request script</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>failure</td>
<td>failure content</td>
<td>render_ajax.php / ajax_request script</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>-</td>
<td>-</td>
<td>render_ajax.php</td>
<td>required_authorization not met</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden</td>
<td>-</td>
<td>-</td>
<td>render_ajax.php / ajax_request script</td>
<td>required_authorization == <span class="caps">FORBIDDEN</span></td>
</tr>
<tr>
<td>404</td>
<td>Not Found</td>
<td>-</td>
<td>-</td>
<td>render_ajax.php</td>
<td>unable to load ajax request script</td>
</tr>
<tr>
<td>500</td>
<td>Internal Server Error</td>
<td>-</td>
<td>format mismatch</td>
<td>render_ajax.php</td>
<td>request returned inappropriately formatted data</td>
</tr>
</table>

<h2 id="ajax_request">AjaxRequest Class</h2>

<h3>Instantiation</h3>

<pre>
$foo = AjaxRequest::get_instance(data_format, ajax_request_script)
</pre>

<p>Where:</p>

<ul>
<li>data_format is one of the legal data formats defined below</li>
<li>ajax_request_script is a script in <em>private_data_root</em> / &#8216;ajax_scripts_</li>
</ul>

<h3>Attributes</h3>

<ul>
<li>ajax_request &#8211; read only &#8211; name of ajax script &#8211; expected to be in <em>private_data_root / ajax_scripts</em></li>
<li>callback &#8211; read only &#8211; only used for <span class="caps">JSONP</span> data format &#8211; name of callback function</li>
<li>content &#8211; read/write &#8211; data which will be returned to the <span class="caps">AJAX</span> requestor. It is
initialized to <span class="caps">FALSE</span> and must be set by the <em>ajax_request</em> script using the <em>add_content()</em>
method. The format of the data <span class="caps">MUST</span> be as described in the following <em>data_format</em>
section.</li>
<li>data_format &#8211; read only &#8211; allowed values with required <em>ajax_request</em> content
and returned data are defined <a href="#data_format">here</a></li>
<li>error_message &#8211; read only &#8211; error messages accumulated during the request</li>
<li>eval_result &#8211; boolean &#8211; <span class="caps">TRUE</span> if <em>ajax_request</em> was found and included</li>
<li>required_authority &#8211; read/write &#8211; Account authority required for request. Legal
values are comma separated list of authorities, &#8216;ANY&#8217;, and &#8216;FORBIDDEN&#8217;.
Defaults to &#8216;FORBIDDEN&#8217;.</li>
</ul>

<h4 id="data_format">Data Format</h4>

<table>
<tr>
<td>Data Format<sup>1</sup></td>
<td>ajax_request content<sup>2</sup></td>
<td>returned <span class="caps">MIME</span>-type<sup>3</sup></td>
</tr>
<tr>
<td>json</td>
<td>associative array</td>
<td>application/json</td>
</tr>
<tr>
<td>jsonp</td>
<td>associateve array</td>
<td>application/javascript</td>
</tr>
<tr>
<td>xml</td>
<td>associative array</td>
<td>application/xml</td>
</tr>
<tr>
<td>html</td>
<td>html text</td>
<td>text/html</td>
</tr>
<tr>
<td>script</td>
<td>javascript as text</td>
<td></td>
</tr>
<tr>
<td>text</td>
<td><span class="caps">UTF</span>-8 text</td>
<td>text/plain</td>
</tr>
</table>

<ol>
<li>Data Format &#8211; ascii string defining the data format to be returned by this
<span class="caps">AJAX</span> request</li>
<li><em>ajax_request</em> content &#8211; the data type which the <em>ajax_request</em> must assign
to the <em>content</em> attribute of the AjaxRequest object</li>
<li>returned <span class="caps">MIME</span>-type &#8211; the value of the Content-Type header which is returned
to the client when the <span class="caps">AJAX</span> request finishes successfully</li>
</ol>

<h3>Class Methods</h3>

<p>None</p>

<h3>Instance Methods</h3>

<p>Instance methods all return <span class="caps">TRUE</span> upon successful completion and <span class="caps">FALSE</span> upon
failure.</p>

<ul>
<li>add_content($content) &#8211; called by ajax_request to append content to
the AjaxRequest object.</li>
<li>add_error($error_message) &#8211; appends <em>$error_message</em> to the <em>error_message</em>
attribute. Does not indicate success or failure.</li>
<li>set_http_status_line($status_code, $reason_phrase) &#8211; sets the <span class="caps">HTTP</span> status
line as specified. <em>ajax_request</em> scripts call this method to indicate errors.
The default values are: &#8216;200&#8217; and &#8216;OK&#8217;.</li>
<li>render() &#8211; renders and returns the result of the <span class="caps">AJAX</span> call.</li>
</ul>

<h3>Returned Data</h3>

<p>Returned data is formatted according to one of the six allowable data formats above.</p>

<p>The response will always contain:</p>

<ul>
<li>result &#8211; either &#8216;success&#8217; or &#8216;failure&#8217;</li>
<li>explanation &#8211; which may be empty</li>
</ul>

<p>If the request was successful, then it may also contain other key/value pairs &#8211; as supplied
by the <em>ajax_request</em>.</p>

<p>The format will of these returned key/value pairs depends on the data format requested.</p>

<ul>
<li>json, jsonp &#8211; <span class="caps">JSON</span> key/value pairs in object form</li>
<li>xml &#8211; <span class="caps">XML</span> elements with key in the element tag and value in the content of the lement</li>
<li>html, text &#8211; formatted human readable</li>
<li>script &#8211; this is the exception: if the <em>ajax_request</em> returns a string, then that string
is returned; if it returns anything else, then an array consisting of all keys/value pairs
is returned as text. [This is open to revision]</li>
</ul>

<h2 id="script_api"><em>ajax_request</em> Script Requirements</h2>

<p>Each <em>ajax_request</em> script must define two functions.</p>

<p>Scripts are not expected to produce output. All output from
scripts is collected and discarded.</p>

<h4>ajax_set_required_authority()</h4>

<p><strong>ajax_set_required_authority()</strong> is responsible for setting
Globals::$web_service->required_authority to enforce security for this <span class="caps">AJAX</span> request.</p>

<p>To do so, it may examine the state of the session, relationship between objects and the
currently active Account (if one is active). It does not need to consider the &#8216;logged_in&#8217;
status of the active Account, as that is handled by this module.</p>

<p>It may set the value of Globals::$web_service->required_authority to a value OR leave it
in its default state: <span class="caps">FORBIDDEN</span>. Legal values may be the distinguished tokens &#8216;ANY&#8217; and
&#8216;FORBIDDEN&#8217; and any legal authority as defined in <a href="/doc.d/system-objects/Account.html">Account.php</a>.</p>

<h5>Returns</h5>

<p>Return code will be one of the following three character ascii strings:</p>

<table>
<tr>
<td>Return Code</td>
<td><span class="caps">HTTP</span> Meaning</td>
<td>Condition</td>
</tr>
<tr>
<td>200</td>
<td>OK</td>
<td>if <em>required_authority</em> is set to any non-FORBIDDEN value</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>if the requested data format is not supported</td>
</tr>
<tr>
<td>403</td>
<td><span class="caps">FORBIDDEN</span></td>
<td>if <em>required_authority</em> is set to &#8216;FORBIDDEN&#8217;</td>
</tr>
</table>

<h4>ajax_content()</h4>

<p><strong>ajax_content()</strong> performs whatever is required for the specific request. Upon encountering
a failure it <span class="caps">MUST</span> call Globals::$web_service->failure(explanation) with an explanation
of the failure <span class="caps">AND</span> immediately return. Upon encountering a non-fatal error, it <span class="caps">MAY</span>
call Globals::$web_service->add_error(message) to append an error message to the error
message string. <em>add_error()</em> may be called as many times as desired.</p>

<p>Upon completing the request successfully, <strong>ajax_content()</strong> <span class="caps">MUST</span> call
Globals::$web_service->success(content) &#8211; where <em>content</em> is the content to be returned.
<em>content</em> can be string or an array &#8211; generally an associative array is preferred for
<em>json</em>, <em>jsonp</em>, and <em>xml</em> data formats. A string is preferred for <em>html</em>
and <em>text</em> formats, but an array will be &#8216;printed&#8217; and appropriately wrapped in
a <em>pre</em> element. <em>script</em> data_format requires a string return.</p>

<p><strong>ajax_content()</strong> acts under the assumption that it has the authority necessary to do
whatever it is designed to do.</p>

<p>The ajax request handler has access to the AjaxRequest object, so it can determine the proper
format for the returned content. Thus, if the <em>data_format</em> is <span class="caps">HTML</span>, it can render and return
an <span class="caps">HTML</span> response, whereas if it is <span class="caps">JSON</span> or <span class="caps">XML</span>, it can return an array.</p>

<h4>Returns</h4>

<p>Returns one of the <span class="caps">HTTP</span> return codes as a three character <span class="caps">ASCII</span> string.</p>

<table>
<tr>
<td>Return Code</td>
<td><span class="caps">HTTP</span> Meaning</td>
<td>Condition</td>
</tr>
<tr>
<td>200</td>
<td>OK</td>
<td>Successful execution with non-null returned content &#8211; which may be null</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request</td>
<td>ajax_request was unable to complete the request, explanation given</td>
</tr>
</table>

<hr />

<h2>Doodles</h2>

<h3>Encapsulate in Standard Object</h3>

<p>Pros &#8211; <span class="caps">AJAX</span> on client side has standard method to get results and success/failure</p>

<p>Cons &#8211; Client side javascript is not written to this standard</p>

<h3>Allow Request script to define returned data</h3>

<p>Pros &#8211; Client Side will get what expects
Request script has full control of returned data, but not format</p>

<p>Cons &#8211; requires more intelligence on part of subordinate request script
don&#8217;t have uniform method to get success/failure results
if client fails to execute, then don&#8217;t know how to indicate that
to client</p>
<?php if (Globals::$site_installation != 'development'): ?>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-1411156-8");
pageTracker._trackPageview();
} catch(err) {}
</script>
<?php endif; ?>
</body>
</html>
